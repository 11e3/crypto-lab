version: '3.8'

# ============================================================================
# Crypto Quant System - Multi-Service Docker Compose Configuration
# ============================================================================
# Services:
#   1. web-ui: Streamlit web interface for backtesting and visualization
#   2. trading-bot: Live trading bot (24/7 operation)
#   3. data-collector: Historical data collection (optional)
#
# Usage:
#   docker-compose up -d web-ui              # Start only web UI
#   docker-compose up -d trading-bot         # Start only trading bot
#   docker-compose up -d                     # Start all services
#   docker-compose logs -f web-ui            # View logs
#   docker-compose down                      # Stop all services
# ============================================================================

services:
  # ==========================================================================
  # Web UI Service - Streamlit Dashboard
  # ==========================================================================
  web-ui:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: crypto-quant-web-ui
    restart: unless-stopped
    ports:
      - "${WEB_SERVER_PORT:-8501}:8501"
    environment:
      # Upbit API Keys (read-only recommended for backtesting)
      - UPBIT_ACCESS_KEY=${UPBIT_ACCESS_KEY}
      - UPBIT_SECRET_KEY=${UPBIT_SECRET_KEY}

      # Web server configuration
      - WEB_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_RUN_ON_SAVE=false

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1
    volumes:
      # Persist data cache for faster backtests
      - ./data:/app/data
      # Persist logs
      - ./logs:/app/logs
      # Optional: Mount config for live updates
      # - ./src/config:/app/src/config:ro
    networks:
      - quant-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # Trading Bot Service - Live Trading (24/7)
  # ==========================================================================
  trading-bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: crypto-quant-trading-bot
    restart: unless-stopped
    command: ["python", "-m", "src.execution.bot.upbit_bot"]
    environment:
      # Upbit API Keys (FULL ACCESS - be careful!)
      - UPBIT_ACCESS_KEY=${UPBIT_ACCESS_KEY}
      - UPBIT_SECRET_KEY=${UPBIT_SECRET_KEY}

      # Telegram Notifications (optional but recommended)
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - TELEGRAM_ENABLED=${TELEGRAM_ENABLED:-true}

      # Trading Configuration
      - TRADING_TICKERS=${TRADING_TICKERS:-KRW-BTC,KRW-ETH,KRW-XRP}
      - TRADING_FEE_RATE=${TRADING_FEE_RATE:-0.0005}
      - TRADING_MAX_SLOTS=${TRADING_MAX_SLOTS:-3}
      - TRADING_MIN_ORDER_AMOUNT=${TRADING_MIN_ORDER_AMOUNT:-5000.0}

      # Strategy Configuration (VBO defaults)
      - STRATEGY_NAME=${STRATEGY_NAME:-VanillaVBO}
      - STRATEGY_SMA_PERIOD=${STRATEGY_SMA_PERIOD:-5}
      - STRATEGY_TREND_SMA_PERIOD=${STRATEGY_TREND_SMA_PERIOD:-10}
      - STRATEGY_SHORT_NOISE_PERIOD=${STRATEGY_SHORT_NOISE_PERIOD:-5}
      - STRATEGY_LONG_NOISE_PERIOD=${STRATEGY_LONG_NOISE_PERIOD:-10}
      - STRATEGY_EXCLUDE_CURRENT=${STRATEGY_EXCLUDE_CURRENT:-true}

      # Bot Configuration
      - BOT_DAILY_RESET_HOUR=${BOT_DAILY_RESET_HOUR:-9}
      - BOT_DAILY_RESET_MINUTE=${BOT_DAILY_RESET_MINUTE:-0}
      - BOT_WEBSOCKET_RECONNECT_DELAY=${BOT_WEBSOCKET_RECONNECT_DELAY:-3.0}
      - BOT_API_RETRY_DELAY=${BOT_API_RETRY_DELAY:-0.5}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1
    volumes:
      # Persist logs (CRITICAL for trading audit trail)
      - ./logs:/app/logs
      # Persist data cache
      - ./data:/app/data
    networks:
      - quant-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    healthcheck:
      test: ["CMD", "python", "-c", "from src.config.settings import Settings; print('OK')"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 30s
    # Security: Drop unnecessary capabilities
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Data Collector Service - Historical Data Collection (Optional)
  # ==========================================================================
  data-collector:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: crypto-quant-data-collector
    restart: "no"  # Run manually or via cron
    command: ["python", "scripts/collect_30min_data.py"]
    environment:
      - UPBIT_ACCESS_KEY=${UPBIT_ACCESS_KEY}
      - UPBIT_SECRET_KEY=${UPBIT_SECRET_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./scripts:/app/scripts:ro
    networks:
      - quant-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - tools  # Only start with --profile tools

# ============================================================================
# Networks
# ============================================================================
networks:
  quant-network:
    driver: bridge
    name: crypto-quant-network

# ============================================================================
# Volumes (optional: use named volumes for better management)
# ============================================================================
# volumes:
#   data-volume:
#     driver: local
#   logs-volume:
#     driver: local
