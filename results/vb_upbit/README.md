# VB Upbit — Parameter Sweep Research

업비트 현물 변동성 돌파(VBO) 전략 파라미터 최적화 연구.
실험 스크립트: `src/research/experiments/vb_upbit.py`
분석 날짜: 2026-02-20

---

## 전략 개요

**진입 조건 (AND)**
- BTC 필터: 전일 BTC 종가 > 전일 BTC MA(`btc_ma`)
- 브레이크아웃: 당일 고가 >= 당일 시가 + 전일 범위 × `noise_ratio`

**청산 조건**
- 전일 종가 < 전일 SMA(`ma_short`) → 당일 시가 청산

**비용 모델**: 수수료 0.05% + 슬리피지 0.05% = 0.10% per leg (왕복 0.20%)

---

## Sweep 1 — 7종목 전체 (리서치 스크립트 기준)

**파일**: `vb_upbit_sweep.csv`
**종목**: KRW-BTC, ETH, XRP, ADA, DOGE, SOL, TRX
**기준**: EW 포트폴리오 Sharpe

| k | ma_filter | ma_exit | EW Sharpe | EW MDD |
|---|-----------|---------|-----------|--------|
| 0.6 | 60 | 3 | **1.623** | -23.1% |
| 0.8 | 50 | 5 | 1.621 | -17.9% |
| 0.8 | 60 | 3 | 1.610 | -20.3% |
| 0.8 | 50 | 3 | 1.604 | **-16.8%** |

> MDD ≤ 30% 조건 내 최소 MDD 우선이면: `k=0.8, ma_filter=50, ma_exit=3`

---

## Sweep 2 — BTC+ETH (리서치 스크립트 기준, Sharpe)

**파일**: `vb_upbit_sweep_btc_eth.csv`
**기준**: EW 포트폴리오 Sharpe

| k | ma_filter | ma_exit | EW Sharpe | EW MDD | avg CAGR |
|---|-----------|---------|-----------|--------|----------|
| 0.5 | 20 | 3 | **2.088** | -25.8% | +106% |
| 0.6 | 20 | 3 | 2.084 | -23.8% | +103% |
| 0.6 | 30 | 3 | 2.080 | -18.8% | +110% |
| 0.8 | 30 | 3 | 2.051 | **-16.9%** | +96% |

> 7종목 대비 Sharpe 1.62 → 2.09 로 상승. BTC+ETH 집중이 유리.

---

## Sweep 3 — BTC+ETH (리서치 스크립트 기준, Sortino)

**파일**: `vb_upbit_sweep_btc_eth_sortino.csv`
**기준**: EW 포트폴리오 Sortino

| k | ma_filter | ma_exit | EW Sortino | EW MDD | avg CAGR |
|---|-----------|---------|------------|--------|----------|
| 0.6 | 30 | **10** | **11.09** | -16.5% | +112% |
| 0.5 | 30 | **10** | 10.66 | -16.5% | +114% |
| 0.8 | 50 | **10** | 10.25 | -21.1% | +92% |

> Sharpe 기준 `ma_exit=3`이 최적인데, Sortino 기준은 `ma_exit=10`이 압도.
> 원인: 독립 자본 합산 후 EW 포트폴리오 구성 시 분산 효과가 하방 변동성을 낮춤 → Sortino 왜곡.

---

## Sweep 4 — BTC+ETH (실제 엔진, Sortino)

**파일**: `vb_upbit_sweep_engine_sortino.csv`
**엔진**: `VectorizedBacktestEngine` (공유 자본 풀, max_slots=2)
**기준**: 포트폴리오 Sortino

| noise_ratio | btc_ma | ma_short | Sortino | Sharpe | CAGR | MDD | Trades |
|-------------|--------|----------|---------|--------|------|-----|--------|
| 0.6 | 20 | **3** | **5.17** | 2.52 | +117% | 17.8% | 552 |
| 0.6 | 30 | **3** | 5.16 | 2.54 | +121% | 17.9% | 547 |
| 0.5 | 30 | **3** | 5.08 | 2.50 | +122% | 18.5% | 622 |

> 실제 엔진에서는 `ma_short=3`이 전 구간 압도.
> 리서치 스크립트 Sortino=11 vs 엔진 Sortino=5 차이는 자본 배분 모델 차이에서 기인 (아래 참조).

---

## Sweep 5 — VBODayExit (익일 시가 무조건 청산)

**파일**: `vb_upbit_sweep_day_exit.csv`
**전략**: 진입 다음날 시가에 무조건 청산 (`exit_signal = entry_signal.shift(1)`)

| noise_ratio | btc_ma | Sortino | Sharpe | CAGR | MDD | Trades |
|-------------|--------|---------|--------|------|-----|--------|
| 0.3 | 30 | 5.00 | 1.99 | +62% | 19.1% | 1,944 |
| 0.3 | 10 | 4.59 | 1.86 | +57% | 21.7% | 1,994 |

**VBOV1 최적 vs VBODayExit 비교**

| 전략 | Sortino | Sharpe | CAGR | MDD | Trades |
|------|---------|--------|------|-----|--------|
| VBOV1 (ma_short=3) | **5.17** | **2.52** | **+118%** | 17.8% | 552 |
| VBODayExit (best) | 5.00 | 1.99 | +62% | 19.1% | 1,944 |

> MA 기반 청산이 "좋은 날은 더, 나쁜 날은 빠르게"를 자동으로 분리.
> 고정 1일 청산은 수수료만 3.5배 많고 성과는 열위.

---

## Sweep 6 — 롤링 Sortino 분석 (365일 윈도우)

**파일**: `vb_upbit_sweep_rolling_sortino.csv`
**목적**: 특정 기간 쏠림 없이 일관되게 성과를 내는 파라미터 식별

### 롤링 Mean Sortino 상위 (전체 구간 평균 품질)

| noise_ratio | btc_ma | ma_short | Roll Mean | Roll Min | neg% | CAGR | MDD |
|-------------|--------|----------|-----------|----------|------|------|-----|
| 0.6 | 20 | 3 | **5.31** | -0.33 | 0.3% | +117% | 17.8% |
| 0.7 | 10 | 3 | 5.25 | +0.19 | 0% | +105% | 26.1% |
| 0.6 | 10 | 3 | 5.22 | -0.29 | 0.1% | +111% | 25.7% |
| 0.6 | 30 | 3 | 5.15 | +0.20 | 0% | +121% | 17.9% |

### 롤링 Min Sortino 상위 (최악 구간 방어력)

| noise_ratio | btc_ma | ma_short | Roll Min | Roll Mean | neg% | CAGR | MDD |
|-------------|--------|----------|----------|-----------|------|------|-----|
| 0.5 | 30 | 3 | **+0.532** | 5.05 | **0%** | +122% | 18.5% |
| 0.8 | 30 | 3 | +0.492 | 4.84 | 0% | +101% | 16.7% |
| 0.4 | 30 | 3 | +0.362 | 4.95 | 0% | +125% | 23.9% |

> `neg%=0%`: 365일 롤링 윈도우 중 Sortino < 0인 구간이 단 한 번도 없음.

---

## 최종 권장 파라미터

| 목적 | noise_ratio | btc_ma | ma_short | 근거 |
|------|-------------|--------|----------|------|
| **균형** (Sharpe+CAGR) | 0.6 | 30 | 3 | Roll Mean 5.15, MDD -17.9%, neg%=0% |
| **수익 최대** | 0.3 | 10 | 3 | CAGR +128%, Roll Mean 5.20 |
| **방어 최강** | 0.5 | 30 | 3 | Roll Min +0.532, 음수 구간 없음 |
| **MDD 최소** | 0.8 | 30 | 3 | MDD -16.7%, Roll Min +0.492 |

---

## 리서치 스크립트 vs 실제 엔진 차이

리서치 스크립트와 실제 엔진은 동일한 전략 로직이지만 **시뮬레이션 모델이 다름**.

| 항목 | 리서치 스크립트 | 실제 엔진 |
|------|----------------|-----------|
| 자본 배분 | 종목별 독립 100% | 공유 자본 풀, max_slots 분할 |
| 포트폴리오 | 사후 수익률 평균 | 실시간 cash + 포지션 MTM |
| 비용 처리 | PnL%에서 flat 차감 | 수량/현금 직접 차감 (더 현실적) |
| 휩소 처리 | 없음 | 명시적 감지 및 비용 계상 |
| 최적 ma_exit | 10 (Sortino 기준) | **3** (모든 기준) |
| Sortino 스케일 | ~11 (분산효과 과장) | ~5 (실제 자본 기준) |

> 실제 거래에는 **엔진 결과가 훨씬 현실적**. 리서치 스크립트는 아이디어 탐색용.

---

## 재현 방법

```bash
# Sweep 1: 7종목 전체
python -m src.research.experiments.vb_upbit --sweep

# 특정 파라미터 단일 실행
python -m src.research.experiments.vb_upbit --k 0.6 --ma-filter 30 --ma-exit 3
```

엔진 기반 스윕은 `src/research/experiments/vb_upbit.py` 상단 주석 참조.
